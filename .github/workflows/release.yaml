name: Build & Release Electron App

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TAG: ${{ github.ref_name }}  # The tag that triggered the workflow
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # -------------------------
      # Platform-specific signing
      # -------------------------
      - name: Configure signing
        id: signing
        shell: powershell
        run: |
          if ($env:RUNNER_OS -eq "Windows") {
              if ("${{ secrets.WIN_CSC_BASE64 }}" -ne "") {
                  $env:CSC_LINK = "codesign.pfx"
                  $env:CSC_KEY_PASSWORD = "${{ secrets.WIN_CSC_PASSWORD }}"
                  [IO.File]::WriteAllBytes("codesign.pfx", [Convert]::FromBase64String("${{ secrets.WIN_CSC_BASE64 }}"))
              } else {
                  $env:CSC_LINK = ""
                  $env:CSC_KEY_PASSWORD = ""
              }
          } elseif ($env:RUNNER_OS -eq "macOS") {
              if ("${{ secrets.APPLE_ID }}" -and "${{ secrets.APPLE_APP_PASSWORD }}" -and "${{ secrets.MAC_CSC_NAME }}") {
                  $env:APPLE_ID = "${{ secrets.APPLE_ID }}"
                  $env:APPLE_APP_SPECIFIC_PASSWORD = "${{ secrets.APPLE_APP_PASSWORD }}"
                  $env:CSC_NAME = "${{ secrets.MAC_CSC_NAME }}"
              }
          }

      # -------------------------
      # Build & publish
      # -------------------------
      - name: Build & publish
        shell: bash
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ env.CSC_LINK || '' }}
          CSC_KEY_PASSWORD: ${{ env.CSC_KEY_PASSWORD || '' }}
          APPLE_ID: ${{ env.APPLE_ID || '' }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ env.APPLE_APP_SPECIFIC_PASSWORD || '' }}
          CSC_NAME: ${{ env.CSC_NAME || '' }}
